<!DOCTYPE html>
<html>
<head>
    <title>Kodik Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .player-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        #player-container {
            flex: 2;
        }
        #translation-list {
            flex: 1;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 450px;
            overflow-y: auto;
        }
        #kodik-player {
            width: 100%;
            height: 450px;
            border: none;
            border-radius: 5px;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        button {
            padding: 8px 15px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #45a049;
        }
        #logs {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .translation-item {
            padding: 10px;
            margin-bottom: 5px;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }
        .translation-item:hover {
            background: #e0e0e0;
        }
        .translation-item.active {
            background: #4CAF50;
            color: white;
        }
        .quality-selector {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Kodik Player</h1>
    
    <div class="player-section">
        <div id="player-container">
            <iframe id="kodik-player" allowfullscreen allow="autoplay *; fullscreen *"></iframe>
        </div>
        
        <div id="translation-list">
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–∑–≤—É—á–∫–∏</h3>
            <div id="translations-container"></div>
            <div class="quality-selector">
                <h3>–ö–∞—á–µ—Å—Ç–≤–æ</h3>
                <select id="quality-select">
                    <option value="">–ê–≤—Ç–æ</option>
                    <option value="1080p">1080p</option>
                    <option value="720p">720p</option>
                    <option value="480p">480p</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button onclick="play()">Play</button>
        <button onclick="pause()">Pause</button>
        <button onclick="seek(60)">Seek 1:00</button>
        <button onclick="changeVolume(0.5)">Volume 50%</button>
        <button onclick="mute()">Mute</button>
        <button onclick="unmute()">Unmute</button>
        <button onclick="changeSpeed(1.5)">Speed 1.5x</button>
        <button onclick="getCurrentTime()">Get Time</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let currentVideoData = null;
        let currentTranslation = null;
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–∏–¥–µ–æ
        async function loadVideo(shikimoriId = '5114') {
            try {
                const response = await fetch(`/api/kodik/videos/${shikimoriId}`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    currentVideoData = data.data;
                    renderTranslations(data.data);
                    
                    // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –æ–∑–≤—É—á–∫–∏
                    if (data.data[0]) {
                        selectTranslation(data.data[0]);
                    }
                } else {
                    log('Error: No video data found');
                }
            } catch (error) {
                log('API Error: ' + error.message);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–∑–≤—É—á–µ–∫
        function renderTranslations(videos) {
            const container = document.getElementById('translations-container');
            container.innerHTML = '';
            
            videos.forEach(video => {
                const translation = video.voice_acting?.[0] || 'Unknown';
                const item = document.createElement('div');
                item.className = 'translation-item';
                item.textContent = `${translation} (${video.quality})`;
                item.onclick = () => selectTranslation(video);
                container.appendChild(item);
            });
        }
        
        // –í—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ–∑–≤—É—á–∫—É
        function selectTranslation(video) {
            const items = document.querySelectorAll('.translation-item');
            items.forEach(item => item.classList.remove('active'));
            
            const player = document.getElementById('kodik-player');
            player.src = 'https:' + video.url;
            
            // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const translation = video.voice_acting?.[0] || 'Unknown';
            const itemsArray = Array.from(items);
            const foundItem = itemsArray.find(item => 
                item.textContent.includes(translation) && 
                item.textContent.includes(video.quality)
            );
            
            if (foundItem) {
                foundItem.classList.add('active');
            }
            
            currentTranslation = video;
            log(`Selected: ${translation} (${video.quality})`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –æ—Ç –ø–ª–µ–µ—Ä–∞
        function kodikMessageListener(message) {
            if (!message.data || !message.data.key) return;

            const eventData = {
                key: message.data.key,
                value: message.data.value || null,
                timestamp: new Date().toLocaleTimeString()
            };

            switch(message.data.key) {
                case 'kodik_player_play':
                    log('‚ñ∂Ô∏è Play');
                    break;
                case 'kodik_player_pause':
                    log('‚è∏ Pause');
                    break;
                case 'kodik_player_seek':
                    log(`‚è© Seek to: ${message.data.value.time}s`);
                    break;
                case 'kodik_player_time_update':
                    log(`‚è± Time: ${message.data.value}s`, false);
                    break;
                case 'kodik_player_duration_update':
                    log(`üïí Duration: ${message.data.value}s`);
                    break;
                case 'kodik_player_video_started':
                    log('üöÄ Video started');
                    break;
                case 'kodik_player_video_ended':
                    log('üèÅ Video ended');
                    break;
                case 'kodik_player_volume_change':
                    log(`üîä Volume: ${message.data.value.volume} (muted: ${message.data.value.muted})`);
                    break;
                case 'kodik_player_current_episode':
                    const ep = message.data.value;
                    log(`üé¨ Episode: S${ep.season}E${ep.episode} (${ep.translation.title})`);
                    break;
                default:
                    log(`Event: ${message.data.key}`, JSON.stringify(message.data.value));
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–æ–º
        function postToPlayer(command) {
            const player = document.getElementById('kodik-player').contentWindow;
            if (player) {
                player.postMessage({ 
                    key: "kodik_player_api", 
                    value: command 
                }, '*');
                log(`Command: ${command.method}`);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function play() { postToPlayer({ method: "play" }); }
        function pause() { postToPlayer({ method: "pause" }); }
        function seek(seconds) { postToPlayer({ method: "seek", seconds }); }
        function changeVolume(volume) { postToPlayer({ method: "volume", volume }); }
        function mute() { postToPlayer({ method: "mute" }); }
        function unmute() { postToPlayer({ method: "unmute" }); }
        function changeSpeed(speed) { postToPlayer({ method: "speed", speed }); }
        function getCurrentTime() { postToPlayer({ method: "get_time" }); }

        function log(message, showFull = true) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            if (showFull) {
                console.log(message);
            }
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É
        document.getElementById('quality-select').addEventListener('change', function() {
            if (!currentVideoData) return;
            
            const quality = this.value;
            let filteredVideos = currentVideoData;
            
            if (quality) {
                filteredVideos = currentVideoData.filter(v => v.quality === quality);
            }
            
             renderTranslations(filteredVideos);

            // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –æ–∑–≤—É—á–∫–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            if (filteredVideos.length > 0) {
                selectTranslation(filteredVideos[0]);
            } else {
                log('–ù–µ—Ç –≤–∏–¥–µ–æ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º');
            }
        });

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç iframe
        window.addEventListener('message', kodikMessageListener);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        loadVideo(); // –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å shikimoriId –≤—Ä—É—á–Ω—É—é
    </script>
</body>
</html>